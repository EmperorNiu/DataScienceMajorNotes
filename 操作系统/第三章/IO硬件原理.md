

## I/O硬件原理

### I/O硬件分类

- 按交互对象分类
  - 人机交互：视频显示设备，鼠标，键盘
  - 与计算机或其他电子设备交互的设备：磁盘磁带
  - 计算机间的通讯设备
- 按交互的方向
  - 输入
  - 输出
  - 输入/输出：磁盘，网卡
- 按外设特性
  - 使用特征
  - 数据传输率
  - 信息组织特征：单个字符，数据块
    - 字符设备：如打印机   无寻址
    - 块设备：如磁盘   可寻址

操作系统要将千差外别的I/O设备屏蔽，提供一个统一友好的接口

### I/O设备：块设备和字符设备

- 块设备
  - 块设备将信息存储在可寻址的固定大小的数据块中
  - 通常数据块大小的范围从512字节到32768字节不等
  - 块设备的主要特征是能够独立的读写单个数据块
  - 磁盘是最常见的块设备
- 字符设备
  - 发送或接受的是字符流
  - 无法编制，也不存在寻址操作

### 设备控制器

> I/O设备通常包含一个机械部件和一个电子部件。电子部件称为设备控制器或适配器
>
> 控制器可以不只控制一个设备
>
> 操作系统大多只与控制器打交道，而非设备本身

- 控制器负责将驱动器读出来的比特流转换成字节块并在需要时进行纠错
- 通常该字节块是在控制器中的一个缓冲区中逐个比特汇集而成。在对检查和进行校验并证实数据正确之后，该块数据随后被拷贝到主存中。

### I/O控制技术

#### 程序控制I/O

- I/O操作由程序发起，并等待操作完成。数据的每次读写通过CPU。

- 每个控制器都有一些用来与CPU通信的寄存器及数据缓冲区

  	- 通过写入寄存器，操作系统可以命令设备发送数据、接收数据、开启或关闭、或其它操作
  	- 通常设备有一个数据缓冲区，以供操作系统读写数据

- 设备编址方式

  - I/O端口：设备寄存器单独编址。每个控制寄存器被分配一个I/O端口号
  - **内存映射I/O**: 设备数据缓冲区按内存地址空间进行统一编址。I/O寄存器是内存地址空间的一部分。通常分配给寄存器的地址位于地址空间的顶端
  - 混合方案：

  <img src = "控制IO.png" width=70%>

- 工作方式：

  - 当CPU想要读一个字时，CPU将地址放到总线上
  - 在总线的一条控制线上设置读信号
  - 用第二条信号线表明需要的是I/O空间还是内存空间（如果内存映射I/O的方法，则每个I/O设备都会将地址线和他所服务的范围进行比较，如果地址落在这一范围内，他就会响应这一请求），然后分别给予响应

#### 中断

- I/O操作是否可以开始或完成
  - 方案一：检测设备控制寄存器中的状态标志位
  - 方案二：使用中断方式通知CPU

- 中断驱动的方式：
  - I/O操作由程序发起，在操作完成时（如数据可读或已经写入）由外设向CPU发出中断，通知该程序。数据的每次读写通过CPU。
  - 优点：在外设进行数据处理时，CPU不必等待，可以继续执行该程序或其他程序。
  - 缺点：CPU每次处理的数据量少（通常不超过几个字节），只适于数据传输率较低的设备。

#### 直接存储器存取（DMA）

- DMA控制器独立于CPU访问系统总线，包含一些可以被CPU读写的寄存器。
- 寄存器指定使用的I/O端口、传输方向、传输单位以及在一次突发传送中要传送的字节数

- 由程序设置DMA(Direct Memory Access )控制器中的若干寄存器值（如内存始址，传送字节数），然后发起I/O操作，而后者完成内存与外设的成批数据交换，在操作完成时由DMA控制器向CPU发出中断。

- 优点：CPU只需干预I/O操作的开始和结束，而其中的一批数据读写无需CPU控制，适于高速设备。

- DMA工作过程：

  <img src = "DMA传送.png" width=90%>

  1. CPU设置DMA控制器的寄存器，告诉它数据的地址，读的大小。之后CPU不在参与
  2. DMA控制器向磁盘控制器发送请求，将要写的内存地址放在总线的地址线上
  3. 磁盘将数据传送到内存指定位置
  4. 磁盘控制器通过总线给DMA控制器发出应答信号；DMA增加要使用的内存地址，减少字节计数。若计数大于零，回到步骤2；否则产生中断，CPU开始工作

#### 通道控制

- 通道控制器(Channel Processor)有自己的专用存储器，可以执行由通道指令组成的通道程序，因此可以进行较为复杂的I/O控制。

- 优点：执行一个通道程序可以完成几批I/O操作

- 通道程序通常由操作系统所构造，放在内存里。

  <img src = "通道控制.png" width=90%>

#### 磁盘为什么需要一个内部缓存区

- 通过内部缓冲，磁盘控制器能在开始传送之前验证校验和。如果校验和是错误的，将发出一个错误的信号并且不传送到内存。
- 一旦磁盘传输开始，从磁盘读出的位流以恒定的速率到达，而不管控制器是否已准备好接收它们。如果控制器试图将数据直接写到内存，那么它必须为要传送的每个字获取系统总线的控制权。如果由于其他设备使用总线而导致总线繁忙，则控制器只能等待。如果下一个磁盘字在前一个还没有存储前到达，则控制器只能把它存在某个地方。如果总线非常忙，则控制器可能需要存储很多字，而且还有大量的管理工作。如果块被放入内部缓冲区，则在DMA开始前不需要使用总线，这样控制器的设计就可以更加简化，因为对DMA到内存的传送没有严格的时间要求。
  

