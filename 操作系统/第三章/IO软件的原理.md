## I/O软件的原理

#### I/O软件目标

- 设备无关性
- 访问任意I/O不需要实现指定设备
  - 程序员写出的软件无需修改便能读出软盘、硬盘以及CD-ROM等不同设备上的文件
- 统一的命名

  - 一个文件或设备名将简单地只是一个字符串或一个整数，而完全不依赖于设备。

  - 在UNIX和MINIX 3中，所有的磁盘可以以任何方式集成到文件系统层次结构中去，用户也不必知道哪个各字对应着哪个设备。
- 容错功能

  - 错误应在尽可能接近硬件的地方处理，低层软件可以自行处理错误，尽可能向上层软件透明
- 协同同步与异步传输

  - 多数物理I/O是异步传输，用户接口是阻塞的，需要使之协同
- 设备共享

  - 某些设备可同时被多个用户使用，另一些设备则在某一时刻只能供一个用户专用
- I/O软件组织层次

<img src="IO软件层次.png" width=70%>

#### I/O中断处理器

- 中断需要尽量加以屏蔽，需将其放在操作系统的底层进行处理，以便其余部分尽可能少地与之发生联系。
  - 屏蔽中断的最好方法是将每一个进行I/O操作的进程挂起，直至I/O操作结束并发生中断。
  - 进程自己阻塞的方法有：执行信号量的DOWN操作、条件变量的WAIT操作；或接收一条消息等等。
- 当中断发生时，中断处理程序执行相应的操作，然后解除相应进程的阻塞状态。
  - 一些系统中是执行信号量的UP操作
  - 在管程中可能是对一个条件变量执行SIGNAL操作，
  - 另一些系统则可能是向阻塞的进程发一条消息
  - 总之其作用是将刚才被阻塞的进程恢复执行。

#### 设备驱动程序

- 设备驱动程序中包括了所有与设备相关的代码。每个设备驱动程序只处理一种设备，或者一类紧密相关的设备
- 设备驱动程序的功能：从与设备无关I/O软件中接收抽象的请求，并负责执行该请求。
- 设备驱动程序放在系统内核中，可以获得良好的性能，但会影响系统的可靠性；MINIX3将其作为用户模式的进程，以提高其可靠性
- 驱动程序的工作流程
  - 检查输入的参数是否有效，如果无效就返回一个错误
  - 将抽象值转化为具体形式
    - 例如对磁盘驱动程序，它包含：计算出所请求块的物理地址、检查驱动器电机是否在运转、检测磁头臂是否定位在正确的柱面等等
  - 一旦决定应向控制器发送什么命令，驱动程序将向控制器的设备寄存器中写入这些命令。
  - 控制命令发出后
    - 驱动程序需等待控制器完成一些操作，所以驱动程序阻塞，直到中断信号到达才解除阻塞
    - 另一种情况是操作没有任何延迟，所以驱动程序无需阻塞。

#### 设备无关I/O软件
- 设备无关软件的基本功能是执行适用于所有设备的常用I/O功能，并向用户层软件提供一个一致的接口。

- 设备无关I/O软件的功能包括
  - 设备驱动程序的统一接口：
    - I/O设备和驱动程序的对外接口需要尽可能的相同，在标准接口情况下，可以方便地加入新的驱动程序
  - 缓冲
    - 对于块设备，硬件每次读写均以块为单元，而用户程序则可以读写任意大小的单元。如果用户进程写半个块，操作系统将在内部保留这些数据，直到其余数据到齐后才一次性地将这些数据写到盘上。
    -  对字符设备，用户向系统写数据的速度可能比向设备输出的速度快，所以需要进行缓冲。超前的键盘输入同样也需要缓冲。
  - 错误报告
    - 只有在底层无法解决时才会通知设备无关软件
  - 分配和释放专用设备
    - 一些设备，如CD-ROM记录器，在同一时刻只能由一个进程使用。这要求操作系统检查对该设备的使用请求，并根据设备的忙闲状况来决定是接受或拒绝此请求。
  - 提供与设备无关的块大小
    - 不同磁盘的扇区大小可能不同，设备无关软件屏蔽了这一事实并向高层软件提供统一的数据块大小

#### 用户空间I/O软件

- I/O相关的库例程
  - 主要工作是提供参数给相应的系统调用并调用之

- 假脱机系统(spooling)
  - 假脱机系统是在多道程序系统中处理专用I/O设备的一种方法
    - 创建一个特殊的守护进程以及一个特殊的目录，称为Spooling目录。
    - 打印一个文件之前，进程首先产生完整的待打印文件并将其放在Spooling目录下。
    - 由该守护进程进行打印，只有该守护进程能够使用打印机设备文件。

#### I/O系统层次的功能总结

<img src="IO系统层次.png" width=70%>

